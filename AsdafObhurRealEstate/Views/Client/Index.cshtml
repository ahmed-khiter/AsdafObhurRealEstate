@model IEnumerable<ListClientDTO>
@inject UserManager<BaseUser> userManager
@{
    var user = await userManager.GetUserAsync(User);

    bool isAccessToDisplay = await userManager.IsInRoleAsync(user, "GeneralManager");
    ViewData["Title"] = "العملاء";

}


<div class="row mb-1" >
    <div class="col-md-4">
        <a class="btn btn-primary" asp-area="" asp-action="create"  asp-controller="Client">
            إضافة عميل
        </a>
    </div>
</div>

<div class="card row mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h4 class="mt-3">أسماء العملاء</h4>
        <div class="tabel-search-box mt-4 ms-9" >
            <input type="text" class="client-search table-search border-0" data-search="search-input" placeholder="بحث بالأسم أو الكود" aria-label="Example text with button addon" aria-describedby="button-addon1">
            <button class="table-search" type="button" id="button-addon1">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

<div class="table-responsive">
    <table class="table align-items-center mb-0">
      <thead>
        <tr>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">كود العميل</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">اسم العميل</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">رقم تلفون العميل</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">حالة الإجراء</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"></th>
         
        </tr>
      </thead>
      <tbody id="data-table">
                @foreach(var record in Model)
                {
                    <tr>
                        <td>
                        <div class="d-flex px-2">
                          <div class="my-auto">
                            <h6 class="mb-0 text-xs">@record.Code</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex px-2">
                          <div class="my-auto">
                            <h6 class="mb-0 text-xs">@record.ClientName</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p dir="rtl" class="text-xs font-weight-normal mb-0">@record.PhoneNumber</p>
                      </td>
                        <td>
                            <div class="d-flex px-2">
                                <div class="my-auto">
                                    <h6 class="mb-0 text-xs">@record.Status</h6>
                                </div>
                            </div>
                        </td>
                      <td class="align-middle">
                          <a class="text-secondary font-weight-bold text-xs" asp-area="" asp-action="details" asp-controller="Client" asp-route-clientId="@record.Id">
                            <span class="material-symbols-outlined">
                              <i title="تفاصيل" class="material-icons-round opacity-10">info</i>
                            </span>
                          </a>

                            <a class="del-record text-secondary font-weight-bold text-xs" data-id="@record.Id">
                                <span class="material-symbols-outlined">
                                    <i title="مسح" class="material-icons-round opacity-10">delete</i>
                                </span>
                            </a>
                      </td>
                </tr>

                }
      </tbody>
    </table>
    </div>
</div>



@section Scripts{

    <script>
        $(document).on('change', '.client-search', function () {
            var isDeletDisplay = @(isAccessToDisplay.ToString().ToLower());

            const inputEle = document.querySelector('[data-search="search-input"]')
            $.ajax({
                url: `/client/SearchClient?userNameOrCode=${inputEle.value}&heCreated=false`,
                type: "Get",
                success: (data) => {
                    $("#data-table").find("tr").remove();
                    data.forEach(element => {
                        if(isDeletDisplay){
                            $("#data-table").append(`
                                <tr>
                                    <td>
                                        <div class="d-flex px-2">
                                            <div class="my-auto">
                                                <h6 class="mb-0 fs-6">${element.code}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex px-2">
                                            <div class="my-auto">
                                                <h6 class="mb-0 fs-6">${element.clientName}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <h6 dir="rtl" class="fs-6 mb-0">${element.phoneNumber}</h6>
                                    </td>
                                        <td>
                                        <div class="d-flex px-2">
                                            <div class="my-auto">
                                        <h6 class="mb-0 fs-6">${element.status}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                                <a class="text-secondary font-weight-bold text-xs" href="/Client/details?clientId=${element.id}">
                                            <span class="material-symbols-outlined fs-6">
                                                <i title="تفاصيل" class="material-icons-round opacity-10">info</i>
                                            </span>
                                        </a>

                                        <a class="del-record text-secondary font-weight-bold text-xs" data-id="${element.id}">
                                            <span class="material-symbols-outlined">
                                                <i title="مسح" class="material-icons-round opacity-10">delete</i>
                                            </span>
                                        </a>
                                    </td>
                                </tr>
                        `)
                        }else{
                            $("#data-table").append(`
                                        <tr>
                                            <td>
                                                <div class="d-flex px-2">
                                                    <div class="my-auto">
                                                        <h6 class="mb-0 fs-6">${element.code}</h6>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex px-2">
                                                    <div class="my-auto">
                                                        <h6 class="mb-0 fs-6">${element.clientName}</h6>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <h6 dir="rtl" class="fs-6 mb-0">${element.phoneNumber}</h6>
                                            </td>
                                                <td>
                                                <div class="d-flex px-2">
                                                    <div class="my-auto">
                                                <h6 class="mb-0 fs-6">${element.status}</h6>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="align-middle">
                                                <a class="text-secondary font-weight-bold text-xs" href="/Client/details?clientId=${element.id}">
                                                    <span class="material-symbols-outlined fs-6">
                                                        <i title="تفاصيل" class="material-icons-round opacity-10">info</i>
                                                    </span>
                                                </a>
                                               
                                            </td>
                                        </tr>
                                `)
                        }
                    });
                },
                error: function (eventFromParam) {
                    Swal.fire({
                        title: 'خطأ اثناء البحث',
                    })
                }
            })
        });

        $(document).on('click', '.del-record', function () {
            debugger;
            var id = $(this).data("id");
            var data = { id };
            Swal.fire({
                title: 'هل أنت متأكد من أنك تريد المسح؟',
                text: "أنت لا تستطيع ارجاع عن هذا الاجراء بعد ذلك",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم !',
                cancelButtonText: 'إالغاء !'
            }).then((result) => {
                if (result.isConfirmed) {
                    debugger;
                    $.ajax({
                        url: '/client/delete',
                        type: "POST",
                        contentType: 'application/x-www-form-urlencoded',
                        data: data,
                        success: (data) => {
                            $(this).parent().parent().remove();
                            Swal.fire(
                                'مسح!',
                                'تم المسح بنجاح.',
                                'تم'
                            )
                        },
                        error: function (eventFromParam) {
                            debugger;
                            console.log(eventFromParam.responseText);
                            console.log(eventFromParam.status);
                            console.log(eventFromParam.responseJSON);
                            console.log(eventFromParam.statusText);
                            Swal.fire({
                                title: 'خطأ اثناء المسح',
                                text: "يجب مسح العملاء المرتبطتين بهذا الموظف"
                            })
                        }
                    })
                }
            })
        });



    </script>
}
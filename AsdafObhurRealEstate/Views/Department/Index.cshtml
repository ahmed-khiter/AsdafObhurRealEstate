
@model IEnumerable<Department>
@{
    ViewData["Title"] = "ألأقسام";
}

<div class="row mb-1" >
    <div class="col-md-4">
        <a class="btn btn-primary" asp-action="create" asp-area="" asp-controller="Department">
            إضافة قسم جديد
        </a>
    </div>
</div>

<div class="card row mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h4 class="mt-3">الأقسام</h4>
        <div class="tabel-search-box mt-4 ms-9" >
            <input type="text" class="department-search table-search border-0" data-search="search-input"  placeholder="بحث باسم القسم" aria-label="Example text with button addon" aria-describedby="button-addon1">
            <button class="table-search" type="button" id="button-addon1">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
  <div class="table-responsive">
    <table class="table align-items-center mb-0">
      <thead>
        <tr>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">اسم القسم</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">تاريخ انشاء القسم</th>
          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"></th>
         
        </tr>
      </thead>
      <tbody id="data-table">
                @foreach(var record in Model)
                {
                    <tr >
                      <td>
                        <div class="d-flex px-2">
                          <div class="my-auto">
                            <h6 class="mb-0 text-xs">@record.Name</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p dir="rtl" class="text-xs font-weight-normal mb-0">@(record.CreatedAt.ToString("dd-MMM-yyyy", new CultureInfo("ar-SA")))</p>
                      </td>
                      <td class="align-middle">
                        <a class="text-secondary font-weight-bold text-xs" asp-area="" asp-action="details" asp-controller="Department" asp-route-id="@record.Id">
                        <span class="material-symbols-outlined">
                            <i title="تفاصيل" class="material-icons-round opacity-10">info</i>
                        </span>
                        </a>

                        <a class="del-record text-secondary font-weight-bold text-xs" data-id="@record.Id" >
                            <span class="material-symbols-outlined">
                                <i title="مسح" class="material-icons-round opacity-10" >delete</i>
                            </span>
                        </a>
                      </td>
                    </tr>

                }
      </tbody>
    </table>
  </div>
  </div>



    @section Scripts {


    <script>

        $(document).on('change','.department-search', function(){
            const inputEle = document.querySelector('[data-search="search-input"]')
               $.ajax({
                        url: `/department/index?departmentName=${inputEle.value}`,
                        type:"Get",
                        success: (data) => {
                              $("#data-table").find("tr").remove();
                              data.forEach(element => {
                                  debugger;
                                  let dateHijri = element.createdAt;

                                  $("#data-table").append(`
                                  <tr >
                                      <td>
                                        <div class="d-flex px-2">
                                          <div class="my-auto">
                                            <h6 class="mb-0 text-xs">${element.name}</h6>
                                          </div>
                                        </div>
                                      </td>
                                      <td>
                                        <p dir="rtl" class="text-xs font-weight-normal mb-0">${dateHijri}</p>
                                      </td>
                                      <td class="align-middle">
                                        <a class="text-secondary font-weight-bold text-xs" href="/department/details/${element.id}">
                                        <span class="material-symbols-outlined">
                                            <i title="تفاصيل" class="material-icons-round opacity-10">info</i>
                                        </span>
                                        </a>

                                        <a class="del-record text-secondary font-weight-bold text-xs" data-id="${element.id}" >
                                            <span class="material-symbols-outlined">
                                                <i title="مسح" class="material-icons-round opacity-10" >delete</i>
                                            </span>
                                        </a>
                                      </td>
                                    </tr>
                              
                                  `)
                              });


                        },
                        error: function (eventFromParam) {
                            Swal.fire({
                                title: 'خطأ اثناء البحث',
                            })
                        }
                    })
        });


        $(document).on('click','.del-record',function(){
            debugger;
            var departmentId = $(this).data("id");
            var data = { departmentId };
            Swal.fire({
              title: 'هل أنت متأكد من أنك تريد المسح؟',
              text: "أنت لا تستطيع ارجاع عن هذا الاجراء بعد ذلك",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'نعم!',
              cancelButtonText: 'إالغاء'
            }).then((result) => {
              if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("delete", "department")',
                        type:"POST",
                        contentType: 'application/x-www-form-urlencoded',
                        data: data,
                        success: (data) =>{
                            $(this).parent().parent().remove();
                            Swal.fire(
                              'مسح!',
                              'تم المسح بنجاح.',
                              'تم'
                            )
                        },
                        error: function (eventFromParam) {
                            Swal.fire({
                                title: 'خطأ اثناء المسح',
                                text:"يجب مسح الموظفين المرتبطين بهذا القسم أو مسح العملاء المرتبطين بهذا القسم"
                            })
                        }
                    })
              }
            })
        });

    </script>
}